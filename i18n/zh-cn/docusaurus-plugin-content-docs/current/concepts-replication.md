---
id: concepts-replication
title: 地理复制
sidebar_label: "地理复制"
description: 全面了解 Pulsar 中的地理复制机制和模式。
---

无论行业如何，当发生意外事件使日常运营停止时，组织需要一个准备充分的灾难恢复计划来快速恢复对客户的服务。然而，灾难恢复计划通常需要具有地理分散数据中心的多数据中心部署。这种多数据中心部署需要地理复制机制，以在数据中心故障时提供额外的冗余。

Pulsar 的地理复制机制通常用于灾难恢复，支持跨多个数据中心复制持久存储的消息数据。例如，你的应用程序在一个区域发布数据，并希望在其他区域处理它以供消费。使用 Pulsar 的地理复制机制，消息可以在不同的地理位置生产和消费。

下图说明了[地理复制](administration-geo.md)的过程。每当三个生产者（P1、P2 和 P3）分别在三个集群中向 T1 主题发布消息时，这些消息会立即在集群间复制。一旦消息被复制，两个消费者（C1 和 C2）可以从他们的集群中消费这些消息。

![Pulsar 中全网格模式的地理复制示例](/assets/full-mesh-replication.svg)

## 复制机制

地理复制机制可以分为同步地理复制和异步地理复制策略。Pulsar 支持这两种复制机制。

### Pulsar 中的异步地理复制

异步地理复制集群由设置在不同数据中心的多个物理集群组成。在 Pulsar 主题上生产的消息首先持久保存到本地集群，然后由 broker 异步复制到远程集群。

![Pulsar 中异步地理复制机制示例](/assets/geo-replication-async.svg)

在正常情况下，当没有连接问题时，消息会被立即复制，与它们被分派给本地消费者的时间相同。通常，端到端传递延迟由数据中心之间的网络往返时间（RTT）定义。应用程序可以在任何集群中创建生产者和消费者，即使远程集群不可访问（例如，在网络分区期间）。

异步地理复制提供较低的延迟，但由于某些数据可能尚未复制的潜在复制延迟，可能导致较弱的一致性保证。

### 通过 BookKeeper 的同步地理复制

在同步地理复制中，数据同步复制到多个数据中心，客户端必须等待来自其他数据中心的确认。如下图所示，当客户端向一个集群发出写入请求时，写入的数据将被复制到其他两个数据中心。只有当大多数数据中心（在此示例中，至少 2 个数据中心）已确认写入已持久化时，写入请求才会被确认给客户端。

![Pulsar 中同步地理复制机制示例](/assets/geo-replication-sync.svg)

Pulsar 中的同步地理复制由 BookKeeper 实现。同步地理复制集群由运行在多个数据中心中的 bookie 集群和 broker 集群，以及全局元数据存储安装（如 ZooKeeper、etcd 或其他跨多个数据中心运行的受支持的元数据存储）组成。你需要配置 BookKeeper 区域感知放置策略来跨多个数据中心存储数据并保证写入的可用性约束。

同步地理复制提供最高的可用性，还保证不同数据中心之间更强的数据一致性。但是，你的应用程序必须为跨数据中心支付额外的延迟惩罚。


## 复制模式

Pulsar 为自定义复制策略提供了很大的灵活性。你可以设置不同的复制模式来为应用程序在多个数据中心之间服务复制策略。

Pulsar 支持以下复制模式：

### 全网格复制

使用全网格复制并应用[选择性消息复制](administration-geo.md#selective-replication)，你可以自定义任意数量数据中心之间的复制策略和拓扑。

![Pulsar 中全网格复制模式示例](/assets/full-mesh-replication.svg)

### 双活复制

双活复制是全网格复制的变体，只有两个数据中心。生产者可以在任何数据中心运行以生产消息，消费者可以从所有数据中心消费所有消息。

![Pulsar 中双活复制模式示例](/assets/active-active-replication.svg)

有关如何使用双活复制在集群之间迁移数据，请参考[这里](administration-geo.md#migrate-data-between-clusters-using-geo-replication)。

### 聚合复制

聚合复制模式通常用于将消息从边缘复制到云。例如，假设你有 3 个集群在 3 个前端数据中心和一个聚合集群在中央数据中心，并且你想将消息从多个前端数据中心复制到中央数据中心用于聚合目的。然后你可以为每个前端数据中心使用的主题创建单独的命名空间，并将聚合数据中心分配给这些命名空间。

![Pulsar 中聚合复制模式示例](/assets/aggregation-replication.svg)