---
id: concepts-tiered-storage
title: 分层存储
sidebar_label: "分层存储"
---

Pulsar 的分段导向架构允许主题积压增长得非常大，实际上没有限制。然而，随着时间的推移，这可能变得昂贵。

缓解这种成本的一种方法是使用分层存储。使用分层存储，积压中的较旧消息可以从 BookKeeper 移动到更便宜的存储机制，同时仍然允许客户端访问积压，就好像什么都没有改变一样。

![分层存储](/assets/pulsar-tiered-storage.png)

## 分层存储如何工作

分层存储利用 Pulsar 的基于分段的架构，其中数据以不可变的分段（账本）存储在 BookKeeper 中。当分段被密封并变为只读时，它们可以安全地卸载到外部存储系统。

### 卸载过程

1. **分段密封**：当 BookKeeper 账本关闭时（由于大小限制、时间限制或手动触发），它变得不可变。
2. **资格检查**：broker 根据配置的策略确定哪些分段有资格卸载。
3. **数据传输**：合格的分段被复制到配置的长期存储后端。
4. **元数据更新**：BookKeeper 元数据被更新以引用外部存储位置。
5. **本地删除**：在可配置的延迟后（默认：4 小时），原始数据从 BookKeeper 中删除。

### 透明访问

消费者可以透明地访问卸载的数据。当消费者请求已卸载的数据时：
- broker 检查 BookKeeper 元数据以确定存储位置
- 如果数据在外部存储中，broker 无缝检索它
- 消费者接收数据，就好像它仍在 BookKeeper 中一样