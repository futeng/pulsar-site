---
id: concepts-cluster-level-failover
title: 集群级故障转移
sidebar_label: "集群级故障转移"
description: 全面了解 Pulsar 中集群级故障转移的概念、优势和用例。
---

````mdx-code-block
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
````

本章描述了集群级故障转移的概念、优势、用例、约束、使用方法、工作原理和更多信息。

### 集群级故障转移概念

````mdx-code-block
<Tabs groupId="failover-choice"
  defaultValue="Automatic cluster-level failover"
  values={[{"label":"自动集群级故障转移","value":"Automatic cluster-level failover"},{"label":"受控集群级故障转移","value":"Controlled cluster-level failover"}]}>
<TabItem value="Automatic cluster-level failover">

自动集群级故障转移支持 Pulsar 客户端在根据**用户**设置的检测策略检测到故障转移事件时，自动无缝地从主集群切换到一个或多个备份集群。

![Pulsar 中的自动集群级故障转移](/assets/cluster-level-failover-1.png)

</TabItem>
<TabItem value="Controlled cluster-level failover">

受控集群级故障转移支持 Pulsar 客户端从主集群切换到一个或多个备份集群。切换由**管理员**手动设置。

![Pulsar 中的受控集群级故障转移](/assets/cluster-level-failover-2.png)

</TabItem>

</Tabs>
````

一旦主集群恢复正常运行，Pulsar 客户端可以切换回主集群。大多数情况下用户甚至不会注意到任何变化。用户可以继续使用应用程序和服务，而不会遇到中断或超时。

### 为什么使用集群级故障转移？

集群级故障转移提供容错、持续可用性和高可用性。它带来许多好处，包括但不限于：

* 降低成本

   服务可以自动切换和恢复，无数据丢失。

* 简化管理

   企业可以在"始终在线"的基础上运营，因为不需要立即的用户干预。

* 提高稳定性和鲁棒性

   它确保持续性能并最小化服务停机时间。

### 何时使用集群级故障转移？

集群级故障转移以多种方式保护您的环境，包括但不限于：

* 灾难恢复

   集群级故障转移可以自动无缝地将主集群上的生产工作负载转移到一个或多个备份集群，这确保了最少的数据损失和减少的恢复时间。

* 计划迁移

   如果你想将生产工作负载从旧集群迁移到新集群，你可以通过集群级故障转移提高迁移效率。例如，你可以在故障转移事件的情况下测试数据迁移是否顺利进行，并在迁移前识别可能的问题和风险。

### 何时触发集群级故障转移？

````mdx-code-block
<Tabs groupId="failover-choice"
  defaultValue="Automatic cluster-level failover"
  values={[{"label":"自动集群级故障转移","value":"Automatic cluster-level failover"},{"label":"受控集群级故障转移","value":"Controlled cluster-level failover"}]}>
<TabItem value="Automatic cluster-level failover">

当 Pulsar 客户端长时间无法连接到主集群时，触发自动集群级故障转移。这可能由多种原因引起，包括但不限于：

* 网络故障

   互联网连接丢失。

* 电源故障

   主集群的关闭时间超过时间限制。

* 服务错误

   主集群上发生错误（例如，主集群因时间限制而无法正常工作）。

* 存储空间崩溃

   主集群没有足够的存储空间，但备份服务器上的相应存储空间正常工作。

</TabItem>
<TabItem value="Controlled cluster-level failover">

当管理员手动设置切换时，触发受控集群级故障转移。

</TabItem>

</Tabs>
````

### 为什么集群级故障转移会失败？

显然，如果备份集群无法被活跃的 Pulsar 客户端访问，集群级故障转移就不会成功。这可能由许多原因引起，包括但不限于：

* 电源故障

   备份集群被关闭或无法正常工作。

* 存储空间崩溃

   主集群和备份集群都没有足够的存储空间。

* 如果故障转移被启动，但没有集群由于错误能够承担可用集群的角色，并且主集群无法正常提供服务。

* 如果你手动启动切换，但服务无法切换到备份集群服务器，那么系统将尝试将服务切换回主集群。

* 主集群和备份集群之间，或两个备份集群之间的身份验证或授权失败。

### 集群级故障转移有什么限制？

目前，集群级故障转移可以执行探测以防止数据丢失，但它无法检查备份集群的状态。如果备份集群不健康，你将无法生产或消费数据。

### 集群级故障转移和地理复制之间有什么关系？

集群级故障转移是[地理复制](concepts-replication.md)的扩展，用于提高稳定性和鲁棒性。集群级故障转移依赖于地理复制，它们有一些**不同**，如下所示。

| 影响                                   | 集群级故障转移                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | 地理复制                                                                                                                                                                                                                                                            |
|-----------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 管理员工作负载重吗？                   | 否或也许。<br /><br />- 对于**自动**集群级故障转移，集群切换基于**用户**设置的策略自动触发。<br /><br />- 对于**受控**集群级故障转移，切换由**管理员**手动触发。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 是。<br /><br />如果集群故障，需要立即的管理干预。                                                                                                                                                                                                                     |
| 会导致数据丢失吗？                     | 否。<br /><br />对于**自动**和**受控**集群级故障转移，如果故障的主集群没有立即将消息复制到备份集群，Pulsar 客户端无法消费未复制的消息。主集群恢复后，Pulsar 客户端切换回来，未复制的数据仍可被 Pulsar 客户端消费。因此，数据不会丢失。<br /><br />- 对于**自动**集群级故障转移，服务可以自动切换和恢复，无数据丢失。<br /><br />- 对于**受控**集群级故障转移，服务可以手动切换和恢复，但可能会发生数据丢失。 | 是。<br /><br />Pulsar 客户端和 DNS 系统有缓存。当管理员将 DNS 从主集群切换到备份集群时，缓存触发超时需要一些时间，这会延迟客户端恢复时间并导致无法生产或消费消息。 |
| 会导致 Pulsar 客户端故障吗？           | 否或也许。<br /><br />- 对于**自动**集群级故障转移，服务可以自动切换和恢复，Pulsar 客户端不会故障。<br /><br />- 对于**受控**集群级故障转移，服务可以手动切换和恢复，但 Pulsar 客户端在管理员采取行动之前会故障。                                                                                                                                                                                                                                                                                                                                                                                                                          | 与上述相同。                                                                                                                                                                                                                                                         |

### 集群级故障转移如何工作？

本章解释了集群级故障转移的工作过程。更多实现细节，请参见 [PIP-121](https://github.com/apache/pulsar/issues/13315)。

````mdx-code-block
<Tabs groupId="failover-choice"
  defaultValue="Automatic cluster-level failover"
  values={[{"label":"自动集群级故障转移","value":"Automatic cluster-level failover"},{"label":"受控集群级故障转移","value":"Controlled cluster-level failover"}]}>
<TabItem value="Automatic cluster-level failover">

在自动故障转移集群中，主集群和备份集群相互了解彼此的可用性。自动故障转移集群无需管理员干预执行以下操作：

1. Pulsar 客户端按照`checkInterval`中定义的间隔运行探测任务。

2. 如果探测任务发现主集群的故障时间超过`failoverDelay`参数中设置的时间，它会搜索备份集群以寻找可用的健康集群。

   2a) 如果有健康的备份集群，Pulsar 客户端按照`secondary`中定义的顺序切换到备份集群。

   2b) 如果没有健康的备份集群，Pulsar 客户端不执行切换，探测任务继续寻找可用的备份集群。

3. 探测任务检查主集群是否正常工作。

   3a) 如果主集群恢复并且连续健康时间超过`switchBackDelay`中设置的时间，Pulsar 客户端切换回主集群。

   3b) 如果主集群没有恢复，Pulsar 客户端不执行切换。

![Pulsar 中自动故障转移集群的工作流](/assets/cluster-level-failover-4.png)

</TabItem>
<TabItem value="Controlled cluster-level failover">

受控故障转移集群在管理员干预下执行以下操作：

1. Pulsar 客户端按照`checkInterval`中定义的间隔运行探测任务。

2. 探测任务从由`urlProvider`配置的 URL 提供者服务获取服务 URL 配置。

   2a) 如果服务 URL 配置发生变化，探测任务切换到目标集群，而不检查目标集群的健康状态。

   2b) 如果服务 URL 配置没有变化，Pulsar 客户端不执行切换。

3. 如果 Pulsar 客户端切换到目标集群，探测任务继续按照`checkInterval`中定义的间隔从 URL 提供者服务获取服务 URL 配置。

   3a) 如果服务 URL 配置发生变化，探测任务切换到目标集群，而不检查目标集群的健康状态。

   3b) 如果服务 URL 配置没有变化，它不执行切换。

![Pulsar 中受控故障转移集群的工作流](/assets/cluster-level-failover-5.png)

</TabItem>

</Tabs>
````

### 如何使用集群级故障转移

请参见[配置集群级故障转移](client-libraries-cluster-level-failover.md)。