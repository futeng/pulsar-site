---
id: txn-how
title: How transactions work?
sidebar_label: "Working principles"
description: Learn the working principles of transactions in Pulsar.
---

本节描述事务组件以及这些组件如何协同工作。有关完整的设计细节，请参阅 [PIP-31: Transactional Streaming](https://docs.google.com/document/d/145VYp09JKTw9jAT-7yNyFU255FptB2_B2Fye100ZXDI/edit#heading=h.bm5ainqxosrx)。

## 关键概念

了解以下关键概念很重要，这是理解事务工作原理的前提条件。

### 事务协调器

事务协调器（TC）是运行在 Pulsar broker 内部的一个模块。

* 它维护事务的整个生命周期，并防止事务进入不正确的状态。

* 它处理事务超时，并确保事务在超时后被中止。

### 事务日志

所有事务元数据都持久化在事务日志中。事务日志由 Pulsar Topic 支持。如果事务协调器崩溃，它可以从事务日志中恢复事务元数据。

事务日志存储的是事务状态，而不是事务中的实际消息（实际消息存储在实际的 Topic 分区中）。

### 事务缓冲区

在事务中发送到 Topic 分区的消息存储在该 Topic 分区的事务缓冲区（TB）中。事务缓冲区中的消息在事务提交之前对消费者不可见。当事务被中止时，事务缓冲区中的消息将被丢弃。

事务缓冲区在内存中存储所有正在进行中和已中止的事务。所有消息都发送到实际的分区化 Pulsar Topic。事务提交后，事务缓冲区中的消息对消费者实体化（可见）。当事务被中止时，事务缓冲区中的消息被丢弃。

### 事务 ID

事务 ID（TxnID）标识 Pulsar 中的唯一事务。事务 ID 是 128 位的。最高 16 位保留给事务协调器的 ID，剩余位用于每个事务协调器中单调递增的数字。通过 TxnID 可以轻松定位事务崩溃的位置。

### 待确认状态

待确认状态在事务完成前维护事务中的消息确认。如果消息处于待确认状态，那么在该消息从待确认状态中移除之前，其他事务无法确认该消息。

待确认状态持久化在待确认日志（游标 ledger）中。新的 broker 可以从待确认日志中恢复状态，以确保确认不会丢失。

## 数据流

为了帮助您调试或调优事务以获得更好的性能，请查看以下图表和描述。

事务的数据流可以分为几个步骤。

### 1. 开始事务

在介绍 Pulsar 中的事务之前，先创建生产者，然后将消息发送到 broker 并存储在数据日志中。

![](/assets/txn-3.png)

让我们逐步了解_开始事务_的步骤。

| 步骤  |  描述  |
| --- | --- |
| 1.1 |  第一步是 Pulsar 客户端找到事务协调器。  |
| 1.2 |  事务协调器为事务分配一个事务 ID。在事务日志中，事务以其事务 ID 和状态（OPEN）进行记录，这确保了无论事务协调器是否崩溃，事务状态都会被持久化。  |
| 1.3 |  事务日志将持久化事务 ID 的结果发送给事务协调器。  |
| 1.4 |  事务状态条目记录后，事务协调器将事务 ID 返回给 Pulsar 客户端。  |

### 2. 使用事务发布消息

在此阶段，Pulsar 客户端进入事务循环，对构成事务的所有消息重复 `consume-process-produce` 操作。这是一个漫长的阶段，可能由多个生产和确认请求组成。

![Workflow of publishing messages with a transaction in Pulsar](/assets/txn-4.png)

让我们逐步了解_使用事务发布消息_的步骤。

| 步骤  |  描述  |
| --- | --- |
| 2.1.1 |  在 Pulsar 客户端向新的 Topic 分区生产消息之前，它向事务协调器发送请求以将该分区添加到事务中。  |
| 2.1.2 |  事务协调器将事务的分区更改记录到事务日志中以确保持久性，这确保事务协调器知道事务正在处理的所有分区。事务协调器可以在结束分区阶段提交或中止每个分区上的更改。  |
| 2.1.3 |  事务日志将记录新分区（用于生产消息）的结果发送给事务协调器。  |
| 2.1.4 |  事务协调器将添加新生产分区的结果发送给事务。  |
| 2.2.1 |  Pulsar 客户端开始向分区生产消息。这部分流程与正常的生产消息流程相同，只是事务生产的消息批次包含事务 ID。  |
| 2.2.2 |  broker 将消息写入分区。  |

### 3. 使用事务确认消息

在此阶段，Pulsar 客户端向事务协调器发送请求，新的订阅被确认为事务的一部分。

![Workflow of acknowledging messages with a transaction in Pulsar](/assets/txn-5.png)

让我们逐步了解_使用事务确认消息_的步骤。

| 步骤  |  描述  |
| --- | --- |
| 3.1.1 |  Pulsar 客户端向事务协调器发送请求以添加确认的订阅。  |
| 3.1.2 |  事务协调器记录订阅的添加，这确保它知道事务处理的所有订阅，并可以在结束阶段提交或中止每个订阅上的更改。  |
| 3.1.3 |  事务日志将记录新分区（用于确认消息）的结果发送给事务协调器。  |
| 3.1.4 |  事务协调器将添加新确认分区的结果发送给事务。  |
| 3.2 |  Pulsar 客户端在订阅上确认消息。这部分流程与正常的确认消息流程相同，只是确认请求携带事务 ID。  |
| 3.3 |  接收确认请求的 broker 检查确认是否属于事务。 |

### 4. 结束事务

在事务结束时，Pulsar 客户端决定提交或中止事务。当在确认消息中检测到冲突时，事务可以被中止。

#### 4.1 结束事务请求

当 Pulsar 客户端完成事务时，它发出结束事务请求。

![Workflow of ending a transaction request in Pulsar](/assets/txn-6.png)

让我们逐步了解_结束事务_的步骤。

| 步骤  |  描述  |
| --- | --- |
| 4.1.1 |  Pulsar 客户端向事务协调器发出结束事务请求（带有一个字段指示事务是提交还是中止）。  |
| 4.1.2 |  事务协调器向其事务日志写入 COMMITTING 或 ABORTING 消息。  |
| 4.1.3 |  事务日志发送记录提交或中止状态的结果。  |

#### 4.2 完成事务

事务协调器开始向涉及此事务的所有分区提交或中止消息的过程。

![Workflow of finalizing a transaction in Pulsar](/assets/txn-7.png)

让我们逐步了解_完成事务_的步骤。

| 步骤  |  描述  |
| --- | --- |
| 4.2.1 |  事务协调器同时在订阅上提交事务，在分区上提交事务。  |
| 4.2.2 |  broker（生产）将生产提交标记写入实际分区。同时，broker（确认）将确认提交标记写入订阅待确认分区。  |
| 4.2.3 |  数据日志将写入生产提交标记的结果发送给 broker。同时，待确认数据日志将写入确认提交标记的结果发送给 broker。游标移动到下一个位置。  |

#### 4.3 将事务标记为 COMMITTED 或 ABORTED

事务协调器将最终事务状态写入事务日志以完成事务。

![Workflow of marking a transaction request in Pulsar](/assets/txn-8.png)

让我们逐步了解_将事务标记为 COMMITTED 或 ABORTED_的步骤。

| 步骤  |  描述  |
| --- | --- |
| 4.3.1 |  在所有生产消息和对涉及此事务的所有分区的确认都已成功提交或中止后，事务协调器将最终的 COMMITTED 或 ABORTED 事务状态消息写入其事务日志，指示事务已完成。可以安全地删除事务日志中与事务关联的所有消息。  |
| 4.3.2 |  事务日志将已提交事务的结果发送给事务协调器。  |
| 4.3.3 |  事务协调器将已提交事务的结果发送给 Pulsar 客户端。  |