---
title: "What’s New in Apache Pulsar 2.11"
date: 2023-01-20
author: "Technoboy-, momo-jun"
---

Apache Pulsar 社区发布了 2.11 版本！61 位贡献者提供了功能增强和修复，共提交了 1617 个代码变更。感谢所有贡献者的付出。

<!--truncate-->

## 2.11 版本亮点

* 将 Pulsar 服务器 Java 构建版本升级到 17 ([PIP-156](https://github.com/apache/pulsar/issues/15207))
* 支持共享订阅的分块功能 ([PR-16202](https://github.com/apache/pulsar/pull/16202))
* 支持可插拔 Topic 工厂 ([PR-12235](https://github.com/apache/pulsar/pull/12235))
* 支持为 `ManagedCursorInfo` 配置压缩类型以平衡存储资源使用 ([PR-14542](https://github.com/apache/pulsar/pull/14542))

这篇博客记录了此版本中最值得注意的变更。如需完整的变更列表，包括所有功能增强和错误修复，请查看 [Pulsar 2.11 发布说明](https://pulsar.apache.org/release-notes/versioned/pulsar-2.11.0/)。

## 重要的功能增强和修复

### Broker
***

#### 在元数据服务中存储订阅属性 ([PR-15757](https://github.com/apache/pulsar/pull/15757))

**问题描述**

重启 broker 或卸载 Topic 可能导致订阅属性丢失，因为它们没有存储在元数据服务中。

**解决方案**

将订阅属性存储在元数据服务（`ManagedCursorInfo`）中。
***

#### 支持为 `ManagedCursorInfo` 配置压缩类型 ([PR-14542](https://github.com/apache/pulsar/pull/14542))

**问题描述**

当游标数据扩展时，数据大小增加，拉取数据需要大量时间。

**解决方案**

引入各种压缩算法来支持游标压缩。

**参考文档：**[managedCursorInfoCompressionType](https://pulsar.apache.org/reference/#/2.11.x/config/reference-configuration-broker?id=managedcursorinfocompressiontype)
***

#### 跨多个云同步 Pulsar 元数据 ([PR-16425](https://github.com/apache/pulsar/pull/16425))

**问题描述**

同步配置元数据（策略）是在集群之间共享租户/命名空间/Topic 策略并在所有集群中统一管理策略的关键路径。但是，早期版本不支持在部署在不同云平台上的 Pulsar 集群之间同步元数据存储（全局 zookeeper）。

**解决方案**

使用两个系统 Topic `metadataSyncEventTopic` 和 `configurationmetadataSyncEventTopic` 以及元数据同步器来在不同云平台上部署的集群之间同步元数据，并使用它持久化本地 Topic 策略。

**参考文档**
- [metadataSyncEventTopic](https://pulsar.apache.org/reference/#/2.11.x/config/reference-configuration-broker?id=metadatasynceventtopic)
- [configurationmetadataSyncEventTopic](https://pulsar.apache.org/reference/#/2.11.x/config/reference-configuration-broker?id=configurationmetadatasynceventtopic)
***

### Producer
***

#### 修复 `ProducerImpl` 中客户端内存限制 `currentUsage` 泄漏 ([PR-16837](https://github.com/apache/pulsar/pull/16837))

**问题描述**

客户端内存限制 `currentUsage` 在 `ProducerImpl` 中泄漏，导致生产者的发送速率变慢。

**解决方案**

当有失败的待处理批次消息时释放内存。
***

#### 在 `batchMessageContainer` 中丢弃消息之前释放信号量 ([PR-17019](https://github.com/apache/pulsar/pull/17019))

**问题描述**

在 `batchMessageContainer` 中丢弃消息和释放信号量时存在竞态条件，导致信号量被持有。

**解决方案**

在 `batchMessageContainer` 中丢弃消息之前释放信号量。
***

### Consumer
***

#### 支持消费者客户端内存限制 ([PR-15216](https://github.com/apache/pulsar/pull/15216))

**问题描述**

拥有大量生产者/消费者的应用程序需要时间为队列大小选择合适的值。具有许多分区的 Topic 也是如此。

**解决方案**

1. 如果内存使用率超过 75%，则阻止消费者接收器队列大小的扩展。
2. 如果内存使用率超过 95%，则触发消费者接收器队列大小的收缩。
***

#### 支持为读取器添加拦截器 ([PR-14729](https://github.com/apache/pulsar/pull/14729))

**问题描述**

Pulsar 支持为生产者和消费者添加拦截器以实现消息跟踪，但没有办法为读取器添加拦截器。

**解决方案**

1. 添加新接口 `ReaderInterceptor` 来自定义读取器拦截器。
2. 支持使用 `ReaderBuilder` 设置读取器拦截器和自动更新分区配置。

**用户文档：**[创建带拦截器的读取器](https://pulsar.apache.org/docs/2.11.x/client-libraries-java/#create-reader-with-interceptor)
***

### Function
***

#### 支持 `Record` 作为 Functions 的新输出类型 ([PR-16041](https://github.com/apache/pulsar/pull/16041))

**问题描述**

在早期版本中，如果您想在 Pulsar 函数中动态设置输出 Topic、消息属性或更改输出 Schema，唯一方法是创建返回 `Void` 的函数。返回像 `Record` 这样携带这些信息的结构会更直观。

**解决方案**

在 `Context` 中添加实用方法 `newOutputRecordBuilder`，返回一个使用源记录信息初始化的 `FunctionRecord` 构建器。可以使用构建器方法根据需要覆盖这些值。

**用户文档：**[使用 `Record` 作为函数输出](https://pulsar.apache.org/docs/2.11.x/functions-develop-api#use-sdk-for-javapythongo)
***

### 分层存储
***

#### 为卸载器添加通用 S3 提供商 ([PR-15710](https://github.com/apache/pulsar/pull/15710))

**问题描述**

Pulsar 通过现有的卸载器支持与 S3 API 兼容的云存储，如 AWS 和阿里云，但强制注册特定元数据限制了它们的使用。

**解决方案**

提供更通用的卸载器 `S3` 以服务更多 S3 兼容的存储，它使用纯 JClouds S3 元数据并允许通过系统属性覆盖默认的 JClouds 属性。

**用户文档：**[在 Pulsar 中使用 S3 卸载器](https://pulsar.apache.org/docs/2.11.x/tiered-storage-s3)
***

### Proxy
***

#### 为 Pulsar 代理支持 `PrometheusRawMetricsProvider` ([PR-14681](https://github.com/apache/pulsar/pull/14681))

**问题描述**

插件的指标无法暴露给 Prometheus 进行监控。

**解决方案**

在 Pulsar 代理中添加 `PrometheusRawMetricsProvider`，以便插件可以将其指标添加到 Prometheus。
***

## 接下来是什么？

如果您有兴趣了解更多关于 Pulsar 2.11 的信息，现在就可以[下载](https://pulsar.apache.org/download/)并试用！

有关 Apache Pulsar 项目和当前进展的更多信息，请访问 [Pulsar 网站](https://pulsar.apache.org)，在 Twitter 上关注项目 [@apache_pulsar](https://twitter.com/apache_pulsar)，并加入 [Pulsar Slack](https://apache-pulsar.slack.com/)！