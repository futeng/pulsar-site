---
title: "What's New in Apache Pulsar 2.10.4"
date: 2023-04-19
author: "liangyepianzhou, Anonymitaet, momo-jun"
---

Apache Pulsar 社区发布了 2.10.4 版本！37 位贡献者提供了改进和 bug 修复，总共包含 12 个提交。感谢所有贡献者的努力。

这篇博客将介绍最值得注意的变更。如需查看完整的变更列表，包括所有功能增强和 bug 修复，请查看 [Pulsar 2.10.4 发布说明](https://pulsar.apache.org/release-notes/versioned/pulsar-2.10.4/)。

<!--truncate-->

### 改进键共享订阅的性能 ([PR-19167](https://github.com/apache/pulsar/pull/19167))

#### 问题
在早期版本中，键共享订阅由于缺乏对粘性哈希的引用计数而存在性能问题。

#### 解决方案
通过为粘性哈希添加引用计数，键共享订阅的性能得到了显著改进。这个优化减少了检查消息是否包含给定粘性哈希集中的哈希所需的时间，从而提高了性能和效率。

### AbstractBatchedMetadataStore - 使用 AlreadyClosedException 替代 IllegalStateException ([PR-19284](https://github.com/apache/pulsar/pull/19284))

#### 问题
在早期版本中，当 Broker 关闭时，`AbstractBatchedMetadataStore` 会使用通用的 `IllegalStateException` 来完成待处理的操作。然而，依赖 `MetadataStore` 的代码通常期望 `MetadataStoreException` 实例，可能无法正确响应这个错误。

#### 解决方案
这个 PR 通过使用 `AlreadyClosedException` 而不是 `IllegalStateException` 来完成待处理操作，改进了 Broker 关闭期间的错误处理。这确保了即使 Broker 正在关闭，相关代码也能更适当地响应错误。

### 修复使用 null-initialPosition 打开游标导致最早位置的问题 ([PR-18416](https://github.com/apache/pulsar/pull/18416))

#### 问题
在早期版本中，调用 `ledger.openCursor("xxx", null)` 时使用 null `initialPosition` 参数会导致游标被设置到最早位置，造成意外行为。这个问题的根本原因是由于 `ManagedLedgerImpl.java` 中对 `initialPosition` 的处理不正确。

#### 解决方案
这个 PR 通过确保在使用 null `initialPosition` 打开游标时使用正确的初始位置来修复问题。代码现在将游标设置为最新位置，符合预期。

### 在 ManagedCursorImpl 中添加 isActive ([PR-19341](https://github.com/apache/pulsar/pull/19341))

#### 问题
在之前的版本中，当一个 Topic 中有多个并发订阅时，Broker 性能会下降，因为在调用 checkBackloggedCursors 时，许多 io 线程会等待锁，synchronized (activeCursors)。

#### 解决方案
这个 PR 在 `ManagedCursorImpl` 中添加了一个 `isActive` 变量，以最小化 `ManagedLedgerImpl` 中对 `activeCursors` 的访问，这减少了锁竞争，提高了有多个并发订阅时的 Broker 性能。

### 支持使用关键字 -partition- 删除分区主题 ([PR-19230](https://github.com/apache/pulsar/pull/19230))

#### 问题
在早期版本中，虽然用户可以在启用分区类型自动创建时使用客户端创建分区主题，但不支持删除这些分区主题。

#### 解决方案
这个 PR 添加了使用关键字 `-partition-` 删除分区主题的支持，使用户更容易管理他们的分区主题。

# 下一步计划？

如果你有兴趣了解更多关于 Pulsar 2.10.4 的信息，可以立即 [下载](https://pulsar.apache.org/download/) 并试用！

有关 Apache Pulsar 项目和当前进展的更多信息，请访问 [Pulsar 网站](https://pulsar.apache.org)，在 Twitter 上关注项目 [@apache_pulsar](https://twitter.com/apache_pulsar)，并加入 [Pulsar Slack](https://apache-pulsar.slack.com/)！