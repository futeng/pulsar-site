---
title: "Apache Pulsar 2.10.1 的新功能"
date: 2022-07-12
author: "codelipenghui, momo-jun"
---

Apache Pulsar 社区发布了 2.10.1 版本！50 位贡献者提供了改进和错误修复，共计 200+ 个提交。感谢您的所有贡献。

2.10.1 版本的亮点是引入了 30+ 个事务修复和改进。早期采用 Pulsar 事务的用户已经在生产环境中记录了长期使用情况，并在实际应用中报告了有价值的发现。这为 Pulsar 社区提供了产生影响的机会。

本博客将介绍最值得注意的更改。有关包含所有功能增强和错误修复的完整列表，请查看 [Pulsar 2.10.1 发布说明](https://pulsar.apache.org/release-notes/versioned/pulsar-2.10.1/)。

<!--truncate-->

### 修复了由于 broker 零资源使用导致的负载管理器无效问题。[PR-15314](https://github.com/apache/pulsar/pull/15314)

#### 问题
在 2.10.0 中引入，在执行负载平衡时，leader broker 的资源使用率（CPU、内存、直接内存等）总是 0。根本原因是将 JSON 数据反序列化为 ResourceUsage POJO 时没有使用构造函数 `ResourceUsage (double usage, double limit)`，所以百分比总是 0。

### 允许具有生产/消费权限的用户获取主题 schema。[PR-15956](https://github.com/apache/pulsar/pull/15956)

#### 问题
在早期版本中，只有具有管理员权限的用户才能获取主题 schema，这使得 schema 使用不便。

#### 解决方案
允许具有元数据访问权限的用户获取主题 schema。订阅者可能来自不同的团队，生产者和订阅者应该能够获取主题 schema，而不是在发布和消费消息之前要求租户管理员这样做。

### 修复了消费性能回归问题。[PR-15162](https://github.com/apache/pulsar/pull/15162)

#### 问题
这个性能回归问题在 2.10.0、2.9.1 和 2.8.3 中引入。在使用 Java 客户端时，您可能会发现消息监听器的性能显著下降。根本原因是每条消息都会引入从外部线程池到内部线程池轮询，然后再到外部线程池的线程切换。

#### 解决方案
2.10.1 是第一个通过避免每条消息的线程切换来提高消费吞吐量从而修复此问题的版本。

### 修复了主题创建的死锁问题。[PR-15570](https://github.com/apache/pulsar/pull/15570)

#### 问题
这个死锁问题发生在主题创建期间，通过尝试从同一线程重新获取相同的 `StampedLock` 来删除它。这将导致主题停止服务很长时间，最终在去重或地理复制检查中失败。变通方法是重启 broker。

### 修复了具有交错延迟的密钥共享消息传递问题。[PR-15409](https://github.com/apache/pulsar/pull/15409)

#### 问题
这是在 2.10.0 中引入的回归问题。当在共享/密钥共享订阅上发生具有交错延迟的延迟消息时，许多消息没有被传递而是停留在积压中。原因是在窥视 `getMessagesToReplayNow()` 时，由于延迟消息控制器中未跟踪的消息 ID，我们无法丢弃返回的集合。

### 优化了 broker 的内存使用。

#### 问题
Pulsar 有一些内部数据结构，如 `ConcurrentLongLongPairHashMap` 和 `ConcurrentLongPairHashMap`，可以减少内存使用而不是使用装箱类型。然而，在早期版本中，即使数据被删除，数据结构也不支持收缩，这在某些情况下浪费了一定量的内存。

**Pull requests**
* https://github.com/apache/pulsar/pull/15354
* https://github.com/apache/pulsar/pull/15342
* https://github.com/apache/pulsar/pull/14663
* https://github.com/apache/pulsar/pull/14515
* https://github.com/apache/pulsar/pull/14497

#### 解决方案
支持内部数据结构的收缩，如 `ConcurrentSortedLongPairSet`、`ConcurrentOpenHashMap` 等。

# 下一步是什么？

如果您有兴趣了解更多关于 Pulsar 2.10.1 的信息，您可以立即[下载](https://pulsar.apache.org/en/versions/)并试用！

**Pulsar Summit San Francisco 2022** 将于 2022 年 8 月 18 日举行。[立即注册](https://pulsar-summit.org/)，并通过在社交媒体上传播消息来帮助我们取得更大的成功！

有关 Apache Pulsar 项目和当前进展的更多信息，请访问
[Pulsar 网站](https://pulsar.apache.org)，在 Twitter
[@apache_pulsar](https://twitter.com/apache_pulsar) 上关注项目，并加入 [Pulsar Slack](https://apache-pulsar.herokuapp.com/)！